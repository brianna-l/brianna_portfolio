<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Image-Tracked AR (Local Libs)</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <style>
    html, body { margin:0; height:100%; background:#000; overflow:hidden; }
    #start {
      position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%);
      padding: 12px 16px; border: 0; border-radius: 12px; background:#fff; color:#000;
      font: 600 16px/1 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; cursor: pointer;
      box-shadow: 0 8px 24px rgba(0,0,0,.35); z-index: 10;
    }
    #log {
      position: fixed; inset: 0 0 auto 0; padding: 8px;
      font: 12px/1.4 ui-monospace, SFMono-Regular, Menlo, monospace; color:#0f0;
      background: linear-gradient(to bottom, rgba(0,0,0,.7), transparent);
      white-space: pre-wrap; max-height: 40vh; overflow: auto; display:none; z-index: 9;
    }
    #hint {
      position: fixed; inset: auto 0 84px 0; text-align: center; color:#fff; opacity:.85; z-index: 5;
      font: 500 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; pointer-events: none;
    }
  </style>
</head>
<body>
  <button id="start">Start AR</button>
  <div id="log"></div>
  <div id="hint">Point your camera at the target image</div>

  <!-- Load LOCAL copies (no CDN) -->
  <script src="./libs/three.min.js"></script>
  <script src="./libs/mindar-image-three.prod.js"></script>

  <script>
    const logBox = document.getElementById('log');
    const log = (...a)=>{ logBox.style.display='block'; logBox.textContent += a.join(' ') + '\n'; console.log(...a); };
    window.addEventListener('error', e => log('JS Error:', e.message));
    window.addEventListener('unhandledrejection', e => log('Promise Rejection:', e.reason?.message || e.reason));

    // Sanity check: did our local libs load?
    if (!window.THREE) alert('Local THREE not found. Is ./libs/three.min.js present?');
    if (!window.MINDAR || !window.MINDAR.IMAGE) alert('Local MindAR not found. Is ./libs/mindar-image-three.prod.js present?');

    // Start on tap (iOS requirement)
    document.getElementById('start').addEventListener('click', async () => {
      try {
        // Make sure targets.mind is reachable
        try {
          const r = await fetch('./targets.mind', { cache: 'no-store' });
          log('targets.mind HTTP', r.status);
          if (!r.ok) throw new Error('Not found');
          const b = await r.blob();
          log('targets.mind size', b.size, 'bytes');
        } catch (e) {
          log('targets.mind load error:', e.message);
        }

        const mindar = new window.MINDAR.IMAGE.MindARThree({
          container: document.body,
          imageTargetSrc: './targets.mind',
          filterMinCF: 0.0005,
          filterBeta: 0.01
        });

        const { renderer, scene, camera } = mindar;

        // lights
        scene.add(new THREE.AmbientLight(0xffffff, 1));
        const dir = new THREE.DirectionalLight(0xffffff, 0.8);
        dir.position.set(0, 1, 1);
        scene.add(dir);

        // anchor + minimal visuals
        const anchor = mindar.addAnchor(0);
        const plate = new THREE.Mesh(
          new THREE.PlaneGeometry(0.08, 0.08),
          new THREE.MeshBasicMaterial({ color: 0xffffff, transparent:true, opacity:0.18 })
        );
        plate.rotation.x = -Math.PI/2;
        plate.position.set(0, 0.005, 0);

        const sphere = new THREE.Mesh(
          new THREE.SphereGeometry(0.02, 32, 32),
          new THREE.MeshStandardMaterial({ color: 0xffffff, emissive: 0xffffff, emissiveIntensity: 0.6, roughness: 0.25 })
        );
        sphere.position.set(0, 0.02, 0);

        const group = new THREE.Group();
        group.add(plate);
        group.add(sphere);
        anchor.group.add(group);

        anchor.onTargetFound = () => { log('Target FOUND'); document.getElementById('hint').style.display = 'none'; };
        anchor.onTargetLost  = () => { log('Target LOST');  document.getElementById('hint').style.display = '';    };

        await mindar.start(); // camera prompt
        document.getElementById('start').remove();

        const clock = new THREE.Clock();
        renderer.setAnimationLoop(() => {
          const t = clock.getElapsedTime();
          sphere.position.y = 0.02 + Math.sin(t * 1.6) * 0.007;
          renderer.render(scene, camera);
        });

      } catch (err) {
        log('Start failed:', err.message || err);
        alert('Start failed: ' + (err.message || err));
      }
    });
  </script>
</body>
</html>
